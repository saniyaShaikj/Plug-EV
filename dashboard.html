<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pune EV Charging ‚Äî Theatre-style Booking + SOC + Routing</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />

  <style>
    :root { --brand:#007BFF; --ok:#28a745; --warn:#ffc107; --bad:#dc3545; --bg:#f5f7fa; }
    body { margin:0; font-family:Inter, Arial, sans-serif; background:var(--bg); color:#111; }
    .topbar { background:var(--brand); color:#fff; padding:10px 16px; display:flex; justify-content:space-between; align-items:center; }
    .wrap { display:grid; grid-template-columns: 1fr 420px; gap:14px; padding:14px; align-items:start; }
    #map { height:520px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.08); }
    .right { max-height:520px; overflow:auto; }
    .panel { background:#fff; padding:12px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.05); margin-bottom:12px; }
    input[type=number], select, input[type=date], input[type=time], input[type=text] { padding:8px; border-radius:6px; border:1px solid #d0d7df; }
    button.primary { background:var(--brand); color:#fff; padding:8px 12px; border-radius:6px; border:none; cursor:pointer; }
    button.ghost { background:transparent; border:1px solid #e6eefb; color:var(--brand); padding:6px 10px; border-radius:6px; cursor:pointer; }
    #stationList .station-item { padding:8px; border-bottom:1px solid #f0f2f5; cursor:pointer; }
    #stationList .station-item:hover { background:#fbfdff; }
    .slot-grid { display:grid; gap:6px; margin-top:10px; overflow:auto; }
    .slots-header { display:flex; gap:6px; }
    .slot-row { display:flex; gap:6px; }
    .slot-cell { min-width:80px; padding:8px; border-radius:6px; text-align:center; cursor:pointer; user-select:none; font-size:13px; }
    .slot-cell.available { background:var(--ok); color:#fff; }
    .slot-cell.booked { background:var(--bad); color:#fff; cursor:not-allowed; opacity:0.95; }
    .slot-cell.selected { background:var(--warn); color:#000; }
    .small { font-size:13px; color:#555; }
    .booking-item { border-top:1px dashed #eef3fb; padding:8px 0; }
    #directionsPanel { max-height:160px; overflow:auto; padding:8px; border-radius:6px; background:#fff; box-shadow:inset 0 0 0 1px #eef3fb; }
    .log { background:#fff; padding:10px; border-radius:8px; max-height:120px; overflow:auto; font-size:13px; }
    .station-popup { font-size:13px; }
    @media (max-width:980px){ .wrap { grid-template-columns:1fr; } .right{ max-height:none; } #map{height:380px} }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="title">üîã Smart EV Charging ‚Äî Pune</div>
    <div>
      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="wrap">
    <!-- LEFT: MAP -->
    <div>
      <div style="padding:12px 0 0 12px; display:flex; gap:8px; align-items:center;">
        <div class="panel" style="display:flex;gap:8px;align-items:center;">
          <label class="small">Enter Current SOC (%)</label>
          <input id="socInput" type="number" min="0" max="100" placeholder="e.g. 40" style="width:90px;">
          <button class="primary" onclick="checkStations()">Show Reachable Stations</button>
          <button class="ghost" onclick="showAllStations()">Show All</button>
        </div>

        <div class="panel" style="min-width:260px;">
          <div style="display:flex;gap:6px;align-items:center;">
            <label class="small">Choose Station</label>
            <select id="stationSelectCompact" style="flex:1"></select>
            <button class="primary" onclick="focusOnSelectedStation()">Go</button>
          </div>
        </div>
      </div>

      <div id="map" class="panel"></div>

      <div class="panel" id="directionsPanel">
        <b>üß≠ Directions</b>
        <div id="directionsContent" class="small">Select a station or click "Route & Directions" on a station popup.</div>
      </div>
    </div>

    <!-- RIGHT: CONTROLS + Booking UI -->
    <div class="right">
      <div class="panel">
        <h3 style="margin:0 0 8px 0;">üéü Slot Booking</h3>

        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <label class="small">Station</label>
          <select id="stationSelect" style="min-width:220px"></select>
        </div>

        <div style="display:flex;gap:8px;margin-top:8px;align-items:center;">
          <label class="small">Date</label>
          <input type="date" id="dateInput" />
        </div>

        <!-- Vehicle type + Manufacturer (filtered by type) -->
        <div style="display:flex;gap:8px;margin-top:8px;align-items:center;flex-wrap:wrap;">
          <label class="small">Vehicle Type</label>
          <select id="vehicleType" style="min-width:160px;">
            <option value="">Select</option>
            <option value="2W">2 Wheeler</option>
            <option value="3W">3 Wheeler</option>
            <option value="4W">4 Wheeler</option>
            <option value="Bus">Bus</option>
            <option value="Truck">Truck</option>
            <option value="ERickshaw">E-Rickshaw</option>
          </select>

          <label class="small">Manufacturer</label>
          <select id="manufacturer" style="min-width:220px;">
            <option value="">Select Vehicle Type First</option>
          </select>
        </div>

        <div style="display:flex;gap:8px;margin-top:8px;align-items:center;">
          <label class="small">Duration (hrs)</label>
          <input id="autoDuration" type="text" readonly style="width:60px;">
        </div>

        <div style="display:flex;gap:8px;margin-top:8px;align-items:center;">
          <label class="small">Guns / Rows</label>
          <span id="gunsInfo" class="small"></span>
          <button class="primary" onclick="loadSlotGrid()">Show Slots</button>
        </div>

        <div id="slotGridWrap" style="margin-top:10px;"></div>

        <div style="display:flex;gap:8px;align-items:center;margin-top:10px;">
          <button class="primary" onclick="confirmBooking()">Confirm Booking</button>
          <button class="ghost" onclick="clearSelection()">Clear</button>
        </div>
      </div>

      <div class="panel">
        <h4 style="margin:0 0 8px 0;">üìä Station List (within SOC range)</h4>
        <div id="stationList" class="small"></div>
      </div>

      <div class="panel">
        <h4 style="margin:0 0 8px 0;">üìú Your Bookings</h4>
        <div id="bookingHistory" class="small"></div>
      </div>

      <div class="panel">
        <h4 style="margin:0 0 8px 0;">üì° Station Console (OCPP Log)</h4>
        <div id="stationLog" class="log small"></div>
      </div>
    </div>
  </div>

  <!-- Leaflet JS + Routing -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

  <script>
  // -------------------------
  // Constants & Storage
  // -------------------------
  if (!localStorage.getItem('loggedInUser')) localStorage.setItem('loggedInUser','guest');
  const STORAGE_KEY = 'ev_allBookings_v1';
  const TIMES = ["08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00"];

  function getAllBookings(){ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
  function saveAllBookings(b){ localStorage.setItem(STORAGE_KEY, JSON.stringify(b)); }

  // -------------------------
  // Stations (same as your list)
  // -------------------------
  const stations = [
    { name: "EV DOCK, Agarkar Nagar, Pune", lat: 18.5278742926, lon: 73.8765824281, guns: 4 },
    { name: "Tata Power Station, N Main Road, Koregaon Park, Pune", lat: 18.48106, lon: 73.863069, guns: 3 },
    { name: "Phoenix Marketcity, Viman Nagar, Pune", lat: 18.567, lon: 73.914, guns: 5 },
    { name: "GoEGO, Westend Mall, Aundh, Pune", lat: 18.5678, lon: 73.7800, guns: 3 },
    { name: "Synergy E Mobility, Talegaon, Pune", lat: 18.7326, lon: 73.6738, guns: 6 },
    { name: "Baner FastCharge Hub, Baner, Pune", lat: 18.5596, lon: 73.7795, guns: 6 },
    { name: "Hinjewadi Rapid Charge, Hinjewadi Phase 1, Pune", lat: 18.5976, lon: 73.7388, guns: 5 },
    { name: "Koregaon Park EV Plaza, Koregaon Park, Pune", lat: 18.5366, lon: 73.8950, guns: 4 },
    { name: "Hadapsar Charging Park, Hadapsar, Pune", lat: 18.5065, lon: 73.9143, guns: 5 },
    { name: "Shivajinagar Charge Point, Shivajinagar, Pune", lat: 18.5213, lon: 73.8597, guns: 3 },
    { name: "Kothrud Rapid, Kothrud, Pune", lat: 18.5062, lon: 73.8288, guns: 4 },
    { name: "Viman Nagar SuperCharge, Viman Nagar, Pune", lat: 18.5663, lon: 73.9139, guns: 5 },
    { name: "Wakad EV Hub, Wakad, Pune", lat: 18.5972, lon: 73.7599, guns: 4 },
    { name: "Pashan Road Charger, Pashan, Pune", lat: 18.5315, lon: 73.7886, guns: 3 },
    { name: "Magarpatta City Charger, Magarpatta, Hadapsar, Pune", lat: 18.5096, lon: 73.9139, guns: 4 },
    { name: "Wadgaon Sheri Station, Wadgaon Sheri, Pune", lat: 18.5360, lon: 73.9255, guns: 3 },
    { name: "Kharadi Charge Hub, Kharadi, Pune", lat: 18.5392, lon: 73.9146, guns: 5 },
    { name: "Lohgaon Airport Station, Near Pune Airport, Lohgaon, Pune", lat: 18.5820, lon: 73.9110, guns: 3 },
    { name: "Pimpri EV Plaza, Pimpri-Chinchwad, Pune", lat: 18.6298, lon: 73.7997, guns: 5 },
    { name: "Bhosari Charge Station, Bhosari, Pimpri-Chinchwad, Pune", lat: 18.6206, lon: 73.8403, guns: 4 },
    { name: "Lonavala FastCharge, Lonavala, Pune District", lat: 18.7500, lon: 73.4090, guns: 4 },
    { name: "Talegaon EV Point, Talegaon, Maval, Pune", lat: 18.7478, lon: 73.7096, guns: 4 },
    { name: "Chakan Charge Hub, Chakan, Pune", lat: 18.7570, lon: 73.9204, guns: 6 },
    { name: "W√ºrth e-Motion EV Charging Station, Baner, Pune", lat: 18.5610, lon: 73.7768, guns: 4 },
    { name: "ChaneGrid Charging Station, Kothrud, Pune", lat: 18.5048, lon: 73.8280, guns: 3 },
    { name: "Oxy Ultima1 Charging Station, Mundhwa / Hadapsar Road, Pune", lat: 18.5040, lon: 73.9230, guns: 5 },
    { name: "Indira EV Charging Station, Shivajinagar, Pune", lat: 18.5220, lon: 73.8590, guns: 4 },
    { name: "Power Bank EV Charging Station, Tathawade, Pune", lat: 18.6165, lon: 73.7475, guns: 6 },
    { name: "Tata Power Charging Station (EZ Charger), Viman Nagar, Pune", lat: 18.5650, lon: 73.9130, guns: 4 },
    { name: "BP Pulse Charging Station, Baner Road, Pune", lat: 18.5550, lon: 73.7870, guns: 4 },
    { name: "Evigo Charging Station, Deccan Gymkhana, Pune", lat: 18.5165, lon: 73.8425, guns: 3 },
    { name: "Kazam Charging Station, Magarpatta Road, Hadapsar, Pune", lat: 18.5075, lon: 73.9145, guns: 4 },
    { name: "Safe Charge EV Charging Station, Shivane, Pune", lat: 18.4930, lon: 73.8550, guns: 4 },
    { name: "Bolt EV Charging Point, Rahatani, Pimpri-Chinchwad, Pune", lat: 18.6310, lon: 73.7990, guns: 3 },
    { name: "UTPL Tathawade Charging Station, Tathawade, Pune", lat: 18.6149, lon: 73.7483, guns: 4 },
    { name: "UTPL EV Charging Station (Panchajanya Automobiles), Akurdi, Pimpri, Pune", lat: 18.6290, lon: 73.7660, guns: 4 },
    { name: "TML Panchajanya Automobiles Charging Station, Akurdi, Pimpri, Pune", lat: 18.6302, lon: 73.7651, guns: 4 },
    { name: "Tata Power Tathawade Charging Station, Tathawade, Pune", lat: 18.6153, lon: 73.7469, guns: 4 },
    { name: "HPCL Walke Charging Station, Walke Nagar, Pimpri, Pune", lat: 18.6299, lon: 73.7577, guns: 3 },
    { name: "Statiq Paramesh House Charging Station, Sangvi, Pune", lat: 18.5355, lon: 73.8378, guns: 4 },
    { name: "Bolt Rahatni Charging Station, Rahatni, Pimpri, Pune", lat: 18.6285, lon: 73.7982, guns: 3 },
    { name: "EV Charging Station - Camp area, Camp, Pune", lat: 18.5204, lon: 73.8567, guns: 3 },
    { name: "Power Bank EV Station (Bhavani Peth), Bhavani Peth, Pune", lat: 18.5090, lon: 73.8715, guns: 3 }
  ];

  // -------------------------
  // Map init & icons
  // -------------------------
  const map = L.map('map').setView([18.5204,73.8567], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'¬© OpenStreetMap contributors' }).addTo(map);

  const userIcon = L.icon({ iconUrl:'https://cdn-icons-png.flaticon.com/512/64/64113.png', iconSize:[32,32], iconAnchor:[16,32] });
  const stationIcon = L.icon({ iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize:[30,30], iconAnchor:[15,30], popupAnchor:[0,-25] });

  let markers = [];
  let userMarker = null;
  let routingControl = null;

  // UI refs
  const stationSelect = document.getElementById('stationSelect');
  const stationSelectCompact = document.getElementById('stationSelectCompact');
  const stationListEl = document.getElementById('stationList');
  const bookingHistoryEl = document.getElementById('bookingHistory');
  const gunsInfoEl = document.getElementById('gunsInfo');
  const slotGridWrap = document.getElementById('slotGridWrap');
  const directionsContent = document.getElementById('directionsContent');
  const stationLogEl = document.getElementById('stationLog');

  function logStation(txt){
    const t = new Date().toLocaleString();
    stationLogEl.innerHTML = `[${t}] ${txt}<br>` + stationLogEl.innerHTML;
  }

  // -------------------------
  // Helpers
  // -------------------------
  function findStation(name){ return stations.find(s=>s.name===name); }

  // Haversine
  function getDistanceKm(lat1,lon1,lat2,lon2){
    const R = 6371;
    const dLat = (lat2-lat1) * Math.PI/180;
    const dLon = (lon2-lon1) * Math.PI/180;
    const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function getBookedCountForStation(stationName, date=null){
    const bookings = getAllBookings();
    return bookings.filter(b => b.station===stationName && (date? b.date===date : true)).length;
  }

  // build matrix for a station and date
  function buildSlotMatrix(stationName, date){
    const st = findStation(stationName);
    const guns = st.guns;
    const bookings = getAllBookings().filter(b => b.station===stationName && b.date===date);
    const matrix = {};
    for(let g=1; g<=guns; g++){
      const rowName = 'Gun ' + g;
      matrix[rowName] = {};
      TIMES.forEach(t => {
        const booking = bookings.find(b => b.time===t && parseInt(b.gun)===g);
        matrix[rowName][t] = booking || null;
      });
    }
    return matrix;
  }

  // -------------------------
  // Populate selects & initial render
  // -------------------------
  function populateStationSelectors(){
    stationSelect.innerHTML = '';
    stationSelectCompact.innerHTML = '';
    stations.forEach(s => {
      const opt = document.createElement('option'); opt.value=s.name; opt.textContent=s.name;
      stationSelect.appendChild(opt);
      stationSelectCompact.appendChild(opt.cloneNode(true));
    });
    updateGunsInfo();
  }

  populateStationSelectors();

  // -------------------------
  // Render markers (filteredStations optional)
  // -------------------------
  function renderMarkers(filteredStations){
    markers.forEach(m => m.remove());
    markers = [];

    (filteredStations || stations).forEach(s => {
      const bookedTotal = getBookedCountForStation(s.name);
      const available = Math.max(0, s.guns - bookedTotal);
      const popupId = `popupSlots_${s.name.replace(/\W/g,'_')}`;

      const popupContent = `<div class="station-popup"><b>${s.name}</b><br>
        Total Guns: ${s.guns} <br>
        Booked: ${bookedTotal} <br>
        Available: ${available} <hr>
        <div id="${popupId}">Loading slots...</div>
        <div style="margin-top:6px">
          <button onclick="openSlotPanel('${s.name}')">Open Slots</button>
          <button onclick="routeToStation(${s.lat},${s.lon}, '${s.name}')">Route & Directions</button>
        </div>
      </div>`;

      const marker = L.marker([s.lat, s.lon], {icon:stationIcon}).addTo(map).bindPopup(popupContent);
      markers.push(marker);

      // populate summary after small delay to ensure popup element exists in DOM when opened
      setTimeout(() => {
        const el = document.getElementById(popupId);
        if (!el) return;
        const bookings = getAllBookings().filter(b => b.station===s.name);
        el.innerHTML = bookings.length === 0 ? '<small>No booked slots</small>' : bookings.slice(-4).map(b=> `üìÖ ${b.date} ${b.time} (Gun ${b.gun})`).join('<br>');
      }, 120);
    });

    if (markers.length){
      try {
        map.fitBounds(L.featureGroup(markers).getBounds().pad(0.15));
      } catch(e){ /* ignore */ }
    }
  }

  // initial
  renderMarkers();

  // -------------------------
  // SOC-based detection
  // -------------------------
  function checkStations(){
    const soc = parseInt(document.getElementById('socInput').value);
    if (isNaN(soc) || soc < 0 || soc > 100){ alert('Enter valid SOC 0‚Äì100'); return; }

    if (!navigator.geolocation){ alert('Geolocation not available'); return; }

    navigator.geolocation.getCurrentPosition(pos => {
      const uLat = pos.coords.latitude, uLon = pos.coords.longitude;
      if (userMarker) userMarker.remove();
      userMarker = L.marker([uLat,uLon], {icon:userIcon}).addTo(map).bindPopup(`You (SOC: ${soc}%)`).openPopup();
      map.setView([uLat,uLon], 13);

      // simple model: 1 km per 1% SOC (same as you used)
      const maxDist = soc * 1;
      const reachable = stations.map(s => ({...s, distance: getDistanceKm(uLat,uLon,s.lat,s.lon)}))
                                .filter(s => s.distance <= maxDist)
                                .sort((a,b)=>a.distance-b.distance);

      renderMarkers(reachable);

      stationListEl.innerHTML = `<div class="small">Stations within ${maxDist.toFixed(1)} km:</div>`;
      reachable.forEach(s => {
        const booked = getBookedCountForStation(s.name);
        const available = Math.max(0, s.guns - booked);
        const div = document.createElement('div');
        div.className = 'station-item';
        div.innerHTML = `<b>${s.name}</b><div class="small">Distance ${s.distance.toFixed(2)} km ‚Äî Guns: ${s.guns} | Booked: ${booked} | Available: ${available}</div>
          <div style="margin-top:6px;">
            <button class="ghost" onclick="openSlotPanel('${s.name}');event.stopPropagation();">Slots</button>
            <button class="primary" onclick="routeToStation(${s.lat},${s.lon}, '${s.name}');event.stopPropagation();">Route</button>
          </div>`;
        stationListEl.appendChild(div);
      });

      logStation(`SOC scan: ${reachable.length} reachable (SOC ${soc}%)`);
    }, err => alert('Error getting location: ' + err.message));
  }

  function showAllStations(){ renderMarkers(); stationListEl.innerHTML = '<div class="small">All stations shown</div>'; }

  // -------------------------
  // Routing
  // -------------------------
  function routeToStation(lat, lon, name){
    if (!userMarker){
      if (navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos => {
          const uLat = pos.coords.latitude, uLon = pos.coords.longitude;
          if (userMarker) userMarker.remove();
          userMarker = L.marker([uLat,uLon], {icon:userIcon}).addTo(map).bindPopup(`You`).openPopup();
          map.setView([uLat,uLon], 13);
          _doRoute(uLat,uLon,lat,lon,name);
        }, err => { alert('Need permission to get your location for routing.'); });
      } else alert('Geolocation not supported.');
    } else {
      const u = userMarker.getLatLng();
      _doRoute(u.lat, u.lng, lat, lon, name);
    }
  }

  function _doRoute(ulat, ulon, tlat, tlon, name){
    if (routingControl) routingControl.remove();
    routingControl = L.Routing.control({
      waypoints: [L.latLng(ulat,ulon), L.latLng(tlat,tlon)],
      router: L.Routing.osrmv1({ serviceUrl:'https://router.project-osrm.org/route/v1' }),
      routeWhileDragging:false, show:false, lineOptions:{styles:[{color:getComputedStyle(document.documentElement).getPropertyValue('--brand')||'#007bff', weight:4}]}
    }).addTo(map);
    routingControl.on('routesfound', e => {
      const r = e.routes[0];
      const distKm = (r.summary.totalDistance/1000).toFixed(2);
      const mins = Math.round(r.summary.totalTime/60);
      let html = `<b>${name}</b><br>Total: ${distKm} km ‚Äî ${mins} mins<hr><ul>`;
      html += `<li>Follow the blue route on the map.</li>`;
      html += `</ul>`;
      directionsContent.innerHTML = html;
      logStation(`Routing to ${name} ‚Äî ${distKm} km, ${mins} mins`);
    });
  }

  // -------------------------
  // Slot grid & selection
  // -------------------------
  let selected = { station:null, date:null, time:null, gun:null, duration:1 };

  function updateGunsInfo(){
    const name = stationSelect.value;
    if (!name) { gunsInfoEl.textContent = ''; return; }
    const st = findStation(name);
    gunsInfoEl.textContent = st ? `${st.guns} guns` : '';
  }
  stationSelect.addEventListener('change', updateGunsInfo);

  function openSlotPanel(stationName){
    stationSelect.value = stationName;
    document.getElementById('dateInput').valueAsDate = new Date();
    updateGunsInfo();
    loadSlotGrid();
    document.querySelector('.right').scrollIntoView({ behavior:'smooth' });
  }

  function loadSlotGrid(){
    const stationName = stationSelect.value;
    const date = document.getElementById('dateInput').value;
    const durationVal = document.getElementById('autoDuration').value;
    const duration = parseInt(durationVal || '1',10);

    if (!stationName){ alert('Choose station'); return; }
    if (!date){ alert('Choose date'); return; }

    selected.station = stationName;
    selected.date = date;
    selected.duration = duration;
    updateGunsInfo();

    const st = findStation(stationName);
    const matrix = buildSlotMatrix(stationName, date);

    slotGridWrap.innerHTML = '';
    const header = document.createElement('div'); header.className='slots-header small';
    header.innerHTML = `<div style="min-width:80px;font-weight:600">Gun \\ Time</div>` + TIMES.map(t=>`<div style="min-width:80px;text-align:center;font-weight:600">${t}</div>`).join('');
    slotGridWrap.appendChild(header);

    for (let g=1; g<=st.guns; g++){
      const rowDiv = document.createElement('div'); rowDiv.className='slot-row';
      const gunLabel = document.createElement('div'); gunLabel.style.minWidth='80px'; gunLabel.style.fontWeight='600'; gunLabel.style.padding='8px'; gunLabel.textContent = `Gun ${g}`;
      rowDiv.appendChild(gunLabel);

      TIMES.forEach(time => {
        const booking = matrix['Gun ' + g][time];
        const cell = document.createElement('div'); cell.className='slot-cell';
        cell.style.minWidth = '80px';
        cell.textContent = time;
        if (booking){
          cell.classList.add('booked');
          cell.title = `Booked by: ${booking.user}\nAt: ${booking.bookingDateTime}`;
        } else {
          cell.classList.add('available');
          cell.onclick = () => selectCell(cell, stationName, date, time, g);
        }
        rowDiv.appendChild(cell);
      });

      slotGridWrap.appendChild(rowDiv);
    }

    // legend
    const legend = document.createElement('div'); legend.className='small'; legend.style.marginTop='8px';
    legend.innerHTML = `<span style="display:inline-block;width:12px;height:12px;background:${getComputedStyle(document.documentElement).getPropertyValue('--ok')};margin-right:6px;border-radius:3px"></span> Available &nbsp;
                        <span style="display:inline-block;width:12px;height:12px;background:${getComputedStyle(document.documentElement).getPropertyValue('--bad')};margin-right:6px;border-radius:3px;margin-left:10px"></span> Booked &nbsp;
                        <span style="display:inline-block;width:12px;height:12px;background:${getComputedStyle(document.documentElement).getPropertyValue('--warn')};margin-right:6px;border-radius:3px;margin-left:10px"></span> Selected`;
    slotGridWrap.appendChild(legend);
  }

  function selectCell(cellEl, station, date, time, gun){
    document.querySelectorAll('.slot-cell.selected').forEach(x=>x.classList.remove('selected'));
    cellEl.classList.add('selected');
    selected.station = station;
    selected.date = date;
    selected.time = time;
    selected.gun = String(gun);
    document.getElementById('dateInput').value = date;
    updateGunsInfo();
  }

  function clearSelection(){
    selected = { station:null, date:null, time:null, gun:null, duration:1 };
    document.querySelectorAll('.slot-cell.selected').forEach(x=>x.classList.remove('selected'));
    document.getElementById('vehicleType').value = "";
    populateManufacturers("");
    document.getElementById('autoDuration').value = "";
  }

  // -------------------------
  // Confirm booking (fixed)
  // -------------------------
  function confirmBooking(){
    const loggedUser = localStorage.getItem('loggedInUser') || 'guest';

    // If user hasn't selected slot via grid, try reading station+date+time fields (time not present as input), so require grid selection.
    if (!selected.station || !selected.date || !selected.time || !selected.gun){
      alert('Please select a slot from the grid before confirming the booking.');
      return;
    }

    // Build booking object
    const booking = {
      id: Date.now(),
      user: loggedUser,
      station: selected.station,
      date: selected.date,
      time: selected.time,
      gun: selected.gun,
      duration: selected.duration || 1,
      bookingDateTime: new Date().toISOString()
    };

    // Save to storage
    const all = getAllBookings();
    // Ensure slot is still free (race condition safety)
    const conflict = all.find(b => b.station===booking.station && b.date===booking.date && b.time===booking.time && b.gun===booking.gun);
    if (conflict){
      alert('Sorry ‚Äî that slot was just taken. Please choose another.');
      renderBookings();
      loadSlotGrid();
      renderMarkers();
      return;
    }

    all.push(booking);
    saveAllBookings(all);

    logStation(`‚úÖ Booking created: ${booking.station} | ${booking.date} ${booking.time} | Gun ${booking.gun} by ${booking.user}`);
    alert('Booking confirmed ‚úîÔ∏è');
      // <-- ADD YOUR LOCALSTORAGE LINES HERE -->
    localStorage.setItem('selectedStation', selected.station);
    localStorage.setItem('selectedVehicleType', document.getElementById('vehicleType').value);
    localStorage.setItem('selectedDuration', selected.duration);
    window.location.href = "payment.html";

    // refresh UI
    renderBookings();
    loadSlotGrid();
    renderMarkers();

    // clear selection so user doesn't accidentally re-book
    clearSelection();
  }

  // -------------------------
  // Bookings UI
  // -------------------------
  function renderBookings(){
    const all = getAllBookings();
    const loggedUser = localStorage.getItem('loggedInUser') || 'guest';
    if (!all.length) {
      bookingHistoryEl.innerHTML = '<div class="small">No bookings yet.</div>';
      return;
    }

    bookingHistoryEl.innerHTML = '';
    all.slice().reverse().forEach((b) => {
      const div = document.createElement('div');
      div.className = 'booking-item';
      div.innerHTML = `
        <b>${b.station}</b><br>${b.date} ${b.time} ‚Äî Gun ${b.gun}<br>
        <small>Booked at: ${new Date(b.bookingDateTime).toLocaleString()}</small><br>
        <small>Booked by: ${b.user}</small>
      `;

      if (b.user === loggedUser) {
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'ghost';
        cancelBtn.textContent = 'Cancel';
        cancelBtn.onclick = () => cancelBooking(b.id);
        div.appendChild(cancelBtn);
      }

      bookingHistoryEl.appendChild(div);
    });
  }

  function cancelBooking(id){
    const loggedUser = localStorage.getItem('loggedInUser') || 'guest';
    let all = getAllBookings();
    const b = all.find(x => x.id === id);
    if (!b) { alert('Booking not found'); return; }

    if (b.user !== loggedUser) { alert('‚ö†Ô∏è You can only cancel your own bookings.'); return; }

    if (!confirm(`Cancel booking at ${b.station} ${b.date} ${b.time} Gun ${b.gun}?`)) return;

    all = all.filter(x => x.id !== id);
    saveAllBookings(all);
    logStation(`‚ùå Booking canceled: ${b.station} | ${b.date} ${b.time} | Gun ${b.gun}`);
    renderBookings();
    loadSlotGrid();
    renderMarkers();
  }

  // -------------------------
  // Vehicle manufacturers & duration rules
  // -------------------------
  const manufByType = {
    "2W": ["Ather","Ola","TVS","Hero Electric","Bajaj Chetak"],
    "3W": ["Mahindra","Piaggio","Ola 3W"],
    "4W": ["Tata","Mahindra","MG","Hyundai","BYD"],
    "Bus": ["Tata Motors","Ashok Leyland","Olectra"],
    "Truck": ["Eicher","Tata Motors","Ashok Leyland","BYD"],
    "ERickshaw": ["Mahindra","Kinetic","Piaggio","Atul"]
  };

  function populateManufacturers(vehicleType){
    const mEl = document.getElementById("manufacturer");
    mEl.innerHTML = "";
    if (!vehicleType){
      const opt = document.createElement('option'); opt.value=""; opt.textContent = "Select Vehicle Type First"; opt.disabled = true; opt.selected = true;
      mEl.appendChild(opt); mEl.disabled = true; return;
    }
    const list = manufByType[vehicleType] || [];
    const placeholder = document.createElement('option'); placeholder.value=""; placeholder.textContent = "Select manufacturer"; placeholder.disabled = true; placeholder.selected = true;
    mEl.appendChild(placeholder);
    list.forEach(name => { const opt = document.createElement('option'); opt.value = name; opt.textContent = name; mEl.appendChild(opt); });
    mEl.disabled = false;
  }

  document.getElementById("vehicleType").addEventListener("change", function(e){
    const vt = e.target.value;
    populateManufacturers(vt);
    autoSetDuration();
  });

  const durationRules = {
    "2W": { "default":1 },
    "3W": { "default":2 },
    "4W": { "default":2 },
    "Bus": { "default":4 },
    "Truck": { "default":5 },
    "ERickshaw": { "default":1 }
  };

  function autoSetDuration(){
    const v = document.getElementById("vehicleType").value;
    const m = document.getElementById("manufacturer").value;
    const out = document.getElementById("autoDuration");
    if(!v){ out.value=""; selected.duration = 1; return; }
    const rule = durationRules[v] || { default:1 };
    const dur = (m && rule[m]) ? rule[m] : rule["default"] || 1;
    out.value = String(dur);
    selected.duration = parseInt(dur,10) || 1;
  }

  document.getElementById("manufacturer").addEventListener("change", autoSetDuration);

  // -------------------------
  // Sync across tabs
  // -------------------------
  window.addEventListener('storage', e => {
    if (e.key === STORAGE_KEY){
      renderBookings();
      loadSlotGrid();
      renderMarkers();
      logStation('üîÅ Bookings updated (sync)');
    }
  });

  // -------------------------
  // Utility & startup
  // -------------------------
  function renderInitial(){
    populateStationSelectors();
    renderBookings();
    showAllStations();
    const today = new Date().toISOString().slice(0,10);
    document.getElementById('dateInput').value = today;
    updateGunsInfo();
    populateManufacturers("");
    autoSetDuration();
  }
  renderInitial();

  function focusOnSelectedStation(){
    const sname = stationSelectCompact.value;
    const st = findStation(sname);
    if (!st) return;
    map.setView([st.lat, st.lon], 15);
  }

  function logout(){ localStorage.removeItem('loggedInUser'); alert('Logged out'); location.reload(); }

  // expose for popups
  window.openSlotPanel = openSlotPanel;
  window.routeToStation = routeToStation;
  window.renderMarkers = renderMarkers;
  </script>

<!-- ‚úÖ NEXT BUTTON (safe + compatible with geolocation) -->
<style>
  #nextButton {
    position: fixed;
    bottom: 20px;
    right: 30px;
    background-color: #007bff;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    transition: background-color 0.3s ease;
    z-index: 9999;
  }

  #nextButton:hover {
    background-color: #0056b3;
  }
</style>

<button id="nextButton">Next ‚Üí</button>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const btn = document.getElementById("nextButton");
    if (btn) {
      btn.addEventListener("click", function() {
        window.location.href = "payment.html"; // change this to your next page
      });
    }
  });
</script>
<!-- ‚úÖ END OF NEXT BUTTON -->

